# Puppet agent download
# https://downloads.puppetlabs.com/windows/puppet5/
#msiexec /qn /norestart /i $file
#msiexec.exe /qn /norestart /i "C:/${parentdir}/${file}" /l*v install.txt
Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
$env:ChocolateyInstall = Convert-Path "$((Get-Command choco).path)\..\.."
Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1"
refreshenv
choco install -y git
choco install -y vscode

$parentdir="larktemp"
$file="puppet-agent-5.5.16-x64.msi"
$url="http://downloads.puppetlabs.com/windows/puppet5/$file"
New-Item -Path "c:\" -Name "$parentdir" -ItemType "directory"
Set-Location "c:\${parentdir}"

$wc = New-Object net.webclient
$wc.Downloadfile("${url}", "c:\${parentdir}\${file}")
$wc = New-Object net.webclient
Start-Process msiexec.exe -Wait -ArgumentList '/I C:\larktemp\puppet-agent-5.5.16-x64.msi /quiet'
sleep 30
refreshenv

cd "C:\ProgramData\PuppetLabs\code\modules"
git clone https://github.com/puppetlabs/puppetlabs-dsc.git
git clone https://github.com/puppetlabs/puppetlabs-reboot.git
git clone https://github.com/nfosdick/windows.git
#git clone https://github.com/puppetlabs/puppetlabs-powershell.git
puppet module install puppetlabs-powershell --version 2.3.0
git clone https://github.com/puppetlabs/ruby-pwsh.git
cd "C:\ProgramData\PuppetLabs\code\modules\windows\manifests"
puppet apply .\test.pp
